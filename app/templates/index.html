<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">OKX Trading Dashboard</h1>

        <!-- 最近运行状态 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">最近运行状态</h2>
            {% if runs %}
            <ul class="list-disc pl-5">
                {% for run in runs %}
                <li class="mb-2">
                    <p class="text-gray-600">时间: {{ run.timestamp }}</p>
                    <p class="text-gray-600">ETH 策略状态: {{ run.eth_status }}</p>
                    <p class="text-gray-600">Vine 策略状态: {{ run.vine_status }}</p>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-600">暂无运行状态记录。</p>
            {% endif %}
        </div>
        
        <!-- 策略卡片容器 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- ETH 策略卡片 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">ETH Strategy</h2>
                    <span id="eth-status" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                </div>
                
                <!-- 参数设置 -->
                <form id="eth-params-form" class="mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Range1 Min (%)</label>
                            <input type="number" name="range1_min" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Range1 Max (%)</label>
                            <input type="number" name="range1_max" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Range2 Threshold (%)</label>
                            <input type="number" name="range2_threshold" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Take Profit (%)</label>
                            <input type="number" name="take_profit_percent" step="0.001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Stop Loss (%)</label>
                            <input type="number" name="stop_loss_percent" step="0.001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Margin (USDT)</label>
                            <input type="number" name="margin" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    <button type="submit" class="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">更新参数</button>
                </form>

                <!-- 性能指标 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-500">总收益 (USDT)</h3>
                        <p id="eth-total-pnl" class="mt-1 text-2xl font-semibold">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-500">胜率</h3>
                        <p id="eth-win-rate" class="mt-1 text-2xl font-semibold">-</p>
                    </div>
                </div>

                <!-- 订单列表 -->
                <div class="overflow-x-auto">
                    <table id="eth-orders" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">方向</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">价格</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VINE 策略卡片 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">VINE Strategy</h2>
                    <span id="vine-status" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                </div>
                
                <!-- 参数设置 -->
                <form id="vine-params-form" class="mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Range1 Min (%)</label>
                            <input type="number" name="range1_min" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Range1 Max (%)</label>
                            <input type="number" name="range1_max" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Range2 Threshold (%)</label>
                            <input type="number" name="range2_threshold" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Take Profit (%)</label>
                            <input type="number" name="take_profit_percent" step="0.001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Stop Loss (%)</label>
                            <input type="number" name="stop_loss_percent" step="0.001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Margin (USDT)</label>
                            <input type="number" name="margin" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    <button type="submit" class="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">更新参数</button>
                </form>

                <!-- 性能指标 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-500">总收益 (USDT)</h3>
                        <p id="vine-total-pnl" class="mt-1 text-2xl font-semibold">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-500">胜率</h3>
                        <p id="vine-win-rate" class="mt-1 text-2xl font-semibold">-</p>
                    </div>
                </div>

                <!-- 订单列表 -->
                <div class="overflow-x-auto">
                    <table id="vine-orders" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">方向</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">价格</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 更新状态标签的样式
        function updateStatusBadge(elementId, isRunning) {
            const badge = document.getElementById(elementId);
            badge.textContent = isRunning ? "运行中" : "已停止";
            badge.className = `px-3 py-1 rounded-full text-sm font-medium ${
                isRunning ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
        }

        // 更新订单表格
        function updateOrdersTable(tableId, orders) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            
            orders.slice(0, 5).forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.ordId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.state}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.side}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.px}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 更新性能指标
        function updatePerformance(strategy, data) {
            document.getElementById(`${strategy}-total-pnl`).textContent = 
                data.total_pnl ? data.total_pnl.toFixed(2) : '-';
            document.getElementById(`${strategy}-win-rate`).textContent = 
                data.win_rate ? `${data.win_rate.toFixed(1)}%` : '-';
        }

        // 更新参数表单
        function updateParamsForm(formId, params) {
            const form = document.getElementById(formId);
            for (const [key, value] of Object.entries(params)) {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) input.value = value;
            }
        }

        // 定期刷新数据
        async function refreshData() {
            try {
                // 获取状态
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                
                // 更新ETH策略
                updateStatusBadge('eth-status', statusData.eth.is_running);
                updateParamsForm('eth-params-form', statusData.eth.parameters);
                
                const ethOrdersResponse = await fetch('/api/orders/eth');
                const ethOrders = await ethOrdersResponse.json();
                updateOrdersTable('eth-orders', ethOrders);
                
                const ethPerformanceResponse = await fetch('/api/performance/eth');
                const ethPerformance = await ethPerformanceResponse.json();
                updatePerformance('eth', ethPerformance);
                
                // 更新VINE策略
                updateStatusBadge('vine-status', statusData.vine.is_running);
                updateParamsForm('vine-params-form', statusData.vine.parameters);
                
                const vineOrdersResponse = await fetch('/api/orders/vine');
                const vineOrders = await vineOrdersResponse.json();
                updateOrdersTable('vine-orders', vineOrders);
                
                const vinePerformanceResponse = await fetch('/api/performance/vine');
                const vinePerformance = await vinePerformanceResponse.json();
                updatePerformance('vine', vinePerformance);
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // 处理参数更新表单提交
        document.getElementById('eth-params-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch('/api/parameters/eth', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    alert('ETH策略参数更新成功');
                    refreshData();
                } else {
                    alert('ETH策略参数更新失败');
                }
            } catch (error) {
                alert('更新参数时发生错误');
                console.error(error);
            }
        });

        document.getElementById('vine-params-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch('/api/parameters/vine', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    alert('VINE策略参数更新成功');
                    refreshData();
                } else {
                    alert('VINE策略参数更新失败');
                }
            } catch (error) {
                alert('更新参数时发生错误');
                console.error(error);
            }
        });

        // 初始加载数据
        refreshData();
        // 每30秒刷新一次数据
        setInterval(refreshData, 30000);
    </script>
</body>
</html>