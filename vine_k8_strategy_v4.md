# VINE-K8 趋势策略 V4 (`vine_k8_strategy_v4.py`) 说明文档

## 1. 策略概述

`VINE-K8 V4` 是一个基于5分钟K线的趋势跟踪策略，专为 `VINE-USDT-SWAP` 永续合约设计。其核心思想是在识别到短期价格动能后，结合中长期EMA趋势进行过滤，最终决定开仓方向。

此版本在V3的基础上，针对**K线分析的严谨性**进行了核心升级。V4版本严格遵循公司《开仓核心逻辑与执行规范》，不再依赖K线在数组中的固定位置，而是通过**检查每根K线的官方完结状态标志**来确定分析基准，极大地提升了策略在真实交易环境中的稳定性和可靠性。

---

## 2. 核心开仓逻辑

策略的开仓决策流程严格遵循公司内部的 **《量化交易策略：开仓核心逻辑与执行规范》**，具体步骤如下：

### 第一步：数据准备与处理

1.  **实时API拉取 (V4修正)**：策略每次运行时，通过调用 `get_candlesticks` 接口直接从OKX API请求最新的**100条**5分钟K线数据。此接口会返回包含“K线完结状态”的完整数据。
2.  **K线状态判断 (V4核心逻辑)**：
    *   **规范遵循**：严格遵循“**必须使用状态为 `1` 的已完结K线进行分析**”的规范。
    *   **动态查找**：`analyze_kline` 函数会从返回的最新K线开始遍历，**动态查找第一根状态位为 `'1'` 的K线**，并将其作为分析基准 `k0`。
    *   **健壮性**：此设计确保了即使用了正确的API，策略逻辑依然能够健壮地处理数据延迟或API返回多根未完结K线等边缘情况，保证了分析起点的绝对可靠。

### 第二步：现有委托检查与处理

此部分逻辑与前序版本保持一致，在开仓前会检查并智能撤销已失效的挂单。

### 第三步：开仓信号生成 (`analyze_kline` 函数)

信号生成逻辑本身不变，但其分析的起点 (`k0`, `k1` 等) 完全基于第一步中动态查找到的已完结K线位置，保证了输入数据的正确性。
1.  **方向判断**：`k0` 和 `k1` 必须**同为阳线或同为阴线**。
2.  **振幅过滤**：
    *   **K0实体振幅** (`body0`) 必须在 `0.9%` 到 `3.5%` 之间。
    *   **K1至K5总振幅** (`total_range`) 必须小于 `2%`。
3.  **入场价格**：入场价格 (`entry_price`) 被设定为 `k0` 的收盘价。

### 第四步：趋势过滤 (`check_trend_with_pandas` 函数)

趋势过滤逻辑与前序版本保持一致，使用 `Pandas` 和 `13, 34, 89` EMA周期进行判断。

### 第五步：最终开仓决策与执行

最终决策逻辑与前序版本保持一致，在信号与趋势匹配时，通过限价单附带止盈止损进行开仓。

---

## 3. V4版本主要变更

1.  **K线分析逻辑重构**：这是V4最核心的升级。通过**检查K线数据中的完结状态位 (`'1'`)** 来动态确定分析基准，取代了之前依赖固定索引的方式。
2.  **可靠性与严谨性提升**：新逻辑使策略能够正确处理各种边缘情况（如API返回多根未收盘K线），确保了交易决策的输入数据始终是准确、已确认的。
3.  **完全符合内部规范**：策略的K线处理方式现已完全符合《开仓核心逻辑与执行规范》的要求。

---

## 4. 开发与操作规范

本策略的开发与运维严格遵守公司规范，包括日志、代码复用、多账户支持和Bark通知等，与前序版本标准一致。
